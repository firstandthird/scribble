/*!
 * scribble - Turn a canvas element into a scribble pad
 * v0.3.0
 * https://github.com/firstandthird/scribble
 * copyright First + Third 2014
 * MIT License
*/
!function(a){function b(a){return a.charAt(0).toUpperCase()+a.slice(1)}a.declare("scribble",{defaults:{color:"#000000",size:2,readMode:!1,stopDrawingTime:500,fullSteps:!0,tool:"pencil",cssClasses:{"canvas-holder":"scribble-canvas-holder","main-canvas":"scribble-main-canvas","shadow-canvas":"scribble-shadow-canvas"}},tools:["pencil","eraser"],_isCanvas:function(){var a=this.el[0],b=!0;return(1!==a.nodeType||"canvas"!==a.nodeName.toLowerCase())&&(b=!1),b},_createCanvas:function(){var b=a("<canvas>");b.appendTo(this.el),this.canvasHolder=this.el,this.el=b},_getId:function(){for(var b,c=0,d=null;null===d;)b="fidel_scribble_"+c,0===a("#"+b).length?d=b:c++;return d},_createWrapper:function(){var b=a("<div>");b.insertBefore(this.el),this.el.appendTo(b),this.canvasHolder=b},_applyClasses:function(){this.canvasHolder.addClass(this.cssClasses["canvas-holder"]),this.el.addClass(this.cssClasses["main-canvas"]),this.shadowCanvas.addClass(this.cssClasses["shadow-canvas"]);var a=getComputedStyle(this.canvasHolder[0]);this.el[0].width=parseInt(a.width,10),this.el[0].height=parseInt(a.height,10),this.shadowCanvas[0].width=parseInt(a.width,10),this.shadowCanvas[0].height=parseInt(a.height,10)},_getContexts:function(){this.shadowContext=this.shadowCanvas[0].getContext("2d"),this.context=this.el[0].getContext("2d")},_createShadowCanvas:function(){this.shadowCanvas=a("<canvas>"),this.shadowCanvas[0].id=this._getId(),this.shadowCanvas.insertAfter(this.el)},_bindEvents:function(){this.shadowCanvas.on("mousemove touchmove",this.proxy(this._saveMouse,this)),this.shadowCanvas.on("mousedown touchstart",this.proxy(this._startDrawing,this)),this.shadowCanvas.on("mouseup touchend",this.proxy(this._stopDrawing,this)),a("body").on("mouseup touchend",this.proxy(this._stopDrawing,this))},_unbindEvents:function(){this.shadowCanvas.off("mousemove touchmove",this.proxy(this._saveMouse,this)),this.shadowCanvas.off("mousedown touchstart",this.proxy(this._startDrawing,this)),this.shadowCanvas.off("mouseup touchend",this.proxy(this._stopDrawing,this)),a("body").off("mouseup",this.proxy(this._stopDrawing,this))},_startDrawing:function(a){return a.stopPropagation(),a.preventDefault(),a.handled===!0?!1:(this.shadowCanvas.on("mousemove touchmove",this.proxy(this._draw,this)),this.drawing=!0,this._saveMouse(a),this._draw(),a.handled=!0,void 0)},_savePoint:function(){var a={x:this.mousePosition.x,y:this.mousePosition.y};this.fullSteps&&(a.size=this.size,a.color=this.color,a.tool=this.tool),this.points.push(a)},_saveMouse:function(a){"touchmove"===a.type&&a.preventDefault();var b=this._getXY(a);this.mousePosition.x=b.x,this.mousePosition.y=b.y,this.drawing&&this._savePoint()},_saveStep:function(){var a={points:this.points.splice(0)};this.doneSteps.push(a)},_stopDrawing:function(a){this.drawing&&(a.stopImmediatePropagation(),this.shadowCanvas.off("mousemove touchmove",this.proxy(this._draw,this)),this._copyShadowToReal(),this.drawing=!1,this._emitDrawingChanged())},_emitDrawingChanged:function(){this.stopTimer&&clearTimeout(this.stopTimer);var a=this;this.stopTimer=setTimeout(function(){a.emit("drawing.changed")},this.stopDrawingTime)},_copyShadowToReal:function(){this.context.drawImage(this.shadowCanvas[0],0,0),this._clearCanvas(this.shadowCanvas,this.shadowContext),this.drawing&&this._saveStep(),this.points=[]},_getXY:function(a){var b,c,d={pageX:0,pageY:0};if("undefined"!=typeof a.changedTouches?d=a.changedTouches[0]:"undefined"!=typeof a.originalEvent&&"undefined"!=typeof a.originalEvent.changedTouches&&(d=a.originalEvent.changedTouches[0]),b=a.offsetX||a.layerX||d.pageX,c=a.offsetY||a.layerY||d.pageY,-1!==a.type.indexOf("touch")){var e=this.shadowCanvas.offset();b-=e.left,c-=e.top}return{x:b,y:c}},_draw:function(){var a=this.points.length,b=this.points[0],c="eraser"===b.tool,d=c?this.context:this.shadowContext,e="",f=!1;if(this.tool!==b.tool&&"undefined"!=typeof b.tool&&(f=!0,e=this.tool,this.changeTool(b.tool)),d.lineWidth=b.size||this.size,d.strokeStyle=b.color||this.color,d.fillStyle=b.color||this.color,0!==a)if(3>a)d.beginPath(),d.arc(b.x,b.y,d.lineWidth/2,0,2*Math.PI,!0),d.fill(),d.closePath();else{c||this._clearCanvas(this.shadowCanvas,this.shadowContext),d.beginPath(),d.moveTo(this.points[0].x,this.points[0].y);for(var g=1;a-2>g;g++){var h=(this.points[g].x+this.points[g+1].x)/2,i=(this.points[g].y+this.points[g+1].y)/2;d.quadraticCurveTo(this.points[g].x,this.points[g].y,h,i)}d.quadraticCurveTo(this.points[g].x,this.points[g].y,this.points[g+1].x,this.points[g+1].y),d.stroke()}return{toolUsed:b.tool,previousTool:e,revertTool:f}},_drawFromSteps:function(a){if(a){this.clear(!0);for(var b=0,c=a.length;c>b;b++){this.points=a[b].points;var d=this._draw();"eraser"!==d.toolUsed&&this._copyShadowToReal(),d.revertTool&&this.changeTool(d.previousTool)}}},init:function(){this._isCanvas()?this._createWrapper():this._createCanvas(),this._createShadowCanvas(),this._applyClasses(),this._getContexts(),this.shadowContext.lineJoin="round",this.body=a("body"),this.mousePosition={x:0,y:0},this.points=[],this.drawing=!1,this.unDoneSteps=[],this.doneSteps=[],this.clear(!0),this.readMode||this._bindEvents(),this.oldColor=this.color,this.changeTool(this.tool)},changeColor:function(a){this.color=a,this.shadowContext.strokeStyle=this.color},changeSize:function(a){this.size=a,this.shadowContext.lineWidth=this.size},changeReadMode:function(a){a?this._bindEvents():this._unbindEvents(),this.readMode=a},toJSON:function(){return this.doneSteps},loadJSON:function(a){this._drawFromSteps(a),this.doneSteps=a},toDataURL:function(){return this.el[0].toDataURL()},loadDataURL:function(a){var b=new Image,c=this.context;b.onload=function(){c.drawImage(this,0,0)},b.src=a.toString()},undo:function(){if(this.doneSteps.length){var a=this.doneSteps.pop();this.unDoneSteps.push(a),this._drawFromSteps(this.doneSteps)}},redo:function(){if(this.unDoneSteps.length){var a=this.unDoneSteps.pop();this.doneSteps.push(a),this._drawFromSteps(this.doneSteps)}},_setPencil:function(){this.context.globalCompositeOperation="source-over",this.color=this.oldColor},_setEraser:function(){this.context.globalCompositeOperation="destination-out",this.oldColor=this.color,this.color="rgba(0,0,0,1)"},changeTool:function(a){if(-1!==this.tools.indexOf(a)){var c="_set"+b(a);this[c].call(this),this.tool=a}else console.error(a+" is not implemented")},_clearCanvas:function(a,b){b.clearRect(0,0,a[0].width,a[0].height)},clear:function(a){a=a||!1,this._clearCanvas(this.el,this.context),a||(this.emit("clear"),this.doneSteps=[])}})}(jQuery);