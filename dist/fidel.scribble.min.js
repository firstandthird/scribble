/*!
 * scribble - Turn a canvas element into a scribble pad
 * v0.1.0
 * https://github.com/firstandthird/scribble
 * copyright First + Third 2013
 * MIT License
*/
!function(a){String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)},a.declare("scribble",{defaults:{color:"#000000",size:2,readMode:!1,tool:"pencil",cssClasses:{"canvas-holder":"scribble-canvas-holder","main-canvas":"scribble-main-canvas","shadow-canvas":"scribble-shadow-canvas"}},tools:["pencil","eraser"],_isCanvas:function(){var a=this.el[0],b=!0;return(1!==a.nodeType||"canvas"!==a.nodeName.toLowerCase())&&(b=!1),b},_createCanvas:function(){var b=a("<canvas>");b.appendTo(this.el),this.canvasHolder=this.el,this.el=b},_getId:function(){for(var b,c=0,d=null;null===d;)b="fidel_scribble_"+c,0===a("#"+b).length?d=b:c++;return d},_createWrapper:function(){var b=a("<div>");b.insertBefore(this.el),this.el.appendTo(b),this.canvasHolder=b},_applyClasses:function(){this.canvasHolder.addClass(this.cssClasses["canvas-holder"]),this.el.addClass(this.cssClasses["main-canvas"]),this.shadowCanvas.addClass(this.cssClasses["shadow-canvas"]);var a=getComputedStyle(this.canvasHolder[0]);this.el[0].width=parseInt(a.width,10),this.el[0].height=parseInt(a.height,10),this.shadowCanvas[0].width=parseInt(a.width,10),this.shadowCanvas[0].height=parseInt(a.height,10)},_getContexts:function(){this.shadowContext=this.shadowCanvas[0].getContext("2d"),this.context=this.el[0].getContext("2d")},_createShadowCanvas:function(){this.shadowCanvas=a("<canvas>"),this.shadowCanvas[0].id=this._getId(),this.shadowCanvas.insertAfter(this.el)},_bindEvents:function(){this.shadowCanvas.on("mousemove touchmove",this.proxy(this._saveMouse,this)),this.shadowCanvas.on("mousedown touchstart",this.proxy(this._startDrawing,this)),this.shadowCanvas.on("mouseup touchend",this.proxy(this._stopDrawing,this)),a("body").on("mouseup touchend",this.proxy(this._stopDrawing,this))},_unbindEvents:function(){this.shadowCanvas.off("mousemove touchmove",this.proxy(this._saveMouse,this)),this.shadowCanvas.off("mousedown touchstart",this.proxy(this._startDrawing,this)),this.shadowCanvas.off("mouseup touchend",this.proxy(this._stopDrawing,this)),a("body").off("mouseup",this.proxy(this._stopDrawing,this))},_startDrawing:function(){this.shadowCanvas.on("mousemove touchmove",this.proxy(this._draw,this)),this.drawing=!0,this._savePoint(),this._draw()},_savePoint:function(){this.points.push({x:this.mousePosition.x,y:this.mousePosition.y,size:this.size,color:this.color,tool:this.tool})},_saveMouse:function(a){var b=this._getXY(a);this.mousePosition.x=b.x,this.mousePosition.y=b.y,this.drawing&&this._savePoint()},_saveStep:function(){var a={points:this.points.splice(0)};this.doneSteps.push(a)},_stopDrawing:function(a){this.drawing&&(a.stopImmediatePropagation(),this.shadowCanvas.off("mousemove touchmove",this.proxy(this._draw,this)),this._copyShadowToReal(),this.drawing=!1)},_copyShadowToReal:function(){this.context.drawImage(this.shadowCanvas[0],0,0),this._clearCanvas(this.shadowCanvas,this.shadowContext),this.drawing&&this._saveStep(),this.points=[]},_getXY:function(a){var b,c;return b=a.offsetX||a.layerX,c=a.offsetY||a.layerY,{x:b,y:c}},_draw:function(){var a=this.points.length,b=this.points[0],c=this.erasing?this.context:this.shadowContext;if(c.lineWidth=b.size,c.strokeStyle=b.color,c.fillStyle=b.color,0!==a)if(3>a)c.beginPath(),c.arc(b.x,b.y,c.lineWidth/2,0,2*Math.PI,!0),c.fill(),c.closePath();else{this.erasing||this._clearCanvas(this.shadowCanvas,this.shadowContext),c.beginPath(),c.moveTo(this.points[0].x,this.points[0].y);for(var d=1;a-2>d;d++){var e=(this.points[d].x+this.points[d+1].x)/2,f=(this.points[d].y+this.points[d+1].y)/2;c.quadraticCurveTo(this.points[d].x,this.points[d].y,e,f)}c.quadraticCurveTo(this.points[d].x,this.points[d].y,this.points[d+1].x,this.points[d+1].y),c.stroke()}},_drawFromSteps:function(a){if(a){this.clear(!0);for(var b=0,c=a.length;c>b;b++)this.points=a[b].points,this._draw(),this._copyShadowToReal()}},init:function(){this._isCanvas()?this._createWrapper():this._createCanvas(),this._createShadowCanvas(),this._applyClasses(),this._getContexts(),this.shadowContext.lineJoin="round",this.mousePosition={x:0,y:0},this.points=[],this.drawing=!1,this.unDoneSteps=[],this.doneSteps=[],this.clear(!0),this.actions=[],this.readMode||this._bindEvents(),this.changeTool(this.tool)},changeColor:function(a){this.emit("colorchanged",[a,this.color]),this.color=a,this.shadowContext.strokeStyle=this.color},changeSize:function(a){this.emit("sizechanged",[a,this.size]),this.size=a,this.shadowContext.lineWidth=this.size},changeReadMode:function(a){a?this._bindEvents():this._unbindEvents(),this.readMode=a},toJSON:function(){return this.doneSteps},loadJSON:function(a){this._drawFromSteps(a)},toDataURL:function(){return this.el.toDataURL()},loadDataURL:function(a){var b=new Image;b.src=a.toString(),this.context.drawImage(b,0,0)},undo:function(){if(this.doneSteps.length){var a=this.doneSteps.pop();this.unDoneSteps.push(a),this._drawFromSteps(this.doneSteps)}},redo:function(){if(this.unDoneSteps.length){var a=this.unDoneSteps.pop();this.doneSteps.push(a),this._drawFromSteps(this.doneSteps)}},_setPencil:function(){this.context.globalCompositeOperation="source-over",this.color=this.oldColor,this.erasing=!1},_setEraser:function(){this.context.globalCompositeOperation="destination-out",this.oldColor=this.color,this.color="rgba(0,0,0,1)",this.erasing=!0},changeTool:function(a){if(-1!==this.tools.indexOf(a)){var b="_set"+a.capitalize();this[b].call(this)}else console.error(a+" is not implemented")},_clearCanvas:function(a,b){b.clearRect(0,0,a[0].width,a[0].height)},clear:function(a){a=a||!1,this._clearCanvas(this.el,this.context),a||this.emit("clear")}})}(jQuery);